// mainwindow.cpp
#include "mainwindow.h"
#include <QDebug>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    m_server = new ServerManager(this);
    connect(m_server, &ServerManager::statusUpdated,
            this, &MainWindow::onServerStatusUpdated);
}

void MainWindow::onServerStatusUpdated(const ServerStatus &status)
{
    QString errCode = status.err_code;
    QString errMsg  = status.err_msg;

    // Không có lỗi -> reset trạng thái
    if (errCode.isEmpty()) {
        m_lastErrorCode.clear();
        m_messageBoxVisible = false;
        return;
    }

    // Nếu đang hiển thị và lỗi không đổi -> bỏ qua
    if (m_messageBoxVisible && errCode == m_lastErrorCode)
        return;

    // Lỗi mới hoặc chưa hiển thị
    m_lastErrorCode = errCode;
    m_messageBoxVisible = true;

    auto *msgBox = new QMessageBox(QMessageBox::Critical,
                                   "Lỗi hệ thống",
                                   QString("Mã lỗi: %1\n%2").arg(errCode, errMsg),
                                   QMessageBox::Ok,
                                   this);

    connect(msgBox, &QMessageBox::finished, this, [=](int){
        m_messageBoxVisible = false;
        m_lastErrorCode.clear();
        msgBox->deleteLater();
    });

    msgBox->show();
}
