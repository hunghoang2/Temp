// mainwindow.cpp
#include "mainwindow.h"
#include <QDebug>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    m_server = new ServerManager(this);
    connect(m_server, &ServerManager::statusUpdated,
            this, &MainWindow::onServerStatusUpdated);
}

void MainWindow::onServerStatusUpdated(const ServerStatus &status)
{
    QSet<QString> currentErrors;
    for (const auto &err : status.errors)
        currentErrors.insert(err.code);

    // 1️⃣ Loại bỏ lỗi đã biến mất khỏi server
    for (auto it = m_activeErrors.begin(); it != m_activeErrors.end(); )
    {
        if (!currentErrors.contains(*it))
            it = m_activeErrors.erase(it); // lỗi biến mất
        else
            ++it;
    }

    // 2️⃣ Duyệt lỗi mới để hiển thị
    for (const auto &err : status.errors)
    {
        if (m_activeErrors.contains(err.code))
            continue; // lỗi này đã hiển thị rồi

        // Hiển thị lỗi mới
        auto *msgBox = new QMessageBox(QMessageBox::Critical,
                                       "Lỗi hệ thống",
                                       QString("Mã lỗi: %1\n%2").arg(err.code, err.message),
                                       QMessageBox::Ok,
                                       this);

        // Khi người dùng tắt, loại bỏ lỗi khỏi danh sách
        connect(msgBox, &QMessageBox::finished, this, [=](int){
            m_activeErrors.remove(err.code);
            msgBox->deleteLater();
        });

        msgBox->show();

        // Đánh dấu lỗi đã hiển thị
        m_activeErrors.insert(err.code);
    }
}
