#include <cmath>
#include <algorithm>

// Tham số cấu hình
struct RampParams {
    float maxSpeed;   // tốc độ tối đa [deg/s]
    float maxAccel;   // gia tốc tối đa [deg/s^2]
    float dt;         // chu kỳ cập nhật [s]
};

// Trạng thái ramp
struct RampState {
    float position;   // góc hiện tại
    float velocity;   // vận tốc hiện tại
};

// Hàm cập nhật ramp S-curve
void rampUpdateSCurve(RampState &state, float target, const RampParams &cfg)
{
    float error = target - state.position;

    // Tính vận tốc mong muốn (hướng đến đích)
    float desiredVel = std::clamp(error / cfg.dt, -cfg.maxSpeed, cfg.maxSpeed);

    // Ramp vận tốc theo gia tốc tối đa
    float dv = desiredVel - state.velocity;
    float maxDv = cfg.maxAccel * cfg.dt;
    if (fabs(dv) > maxDv)
        state.velocity += copysign(maxDv, dv);
    else
        state.velocity = desiredVel;

    // Giảm tốc nếu sắp vượt đích (năng lượng dừng lại vừa đủ)
    if ((state.velocity > 0 && error < 0) || (state.velocity < 0 && error > 0))
        state.velocity = 0;

    // Cập nhật vị trí
    state.position += state.velocity * cfg.dt;
}
