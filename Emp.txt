#include <iostream>
#include <string>
#include <array>
#include <algorithm>
#include <cctype>
#include <cstdio>   // FILE, popen, pclose

// Hàm thực thi lệnh shell và lấy toàn bộ output (stdout + stderr)
std::string execCommand(const std::string& cmd) {
    std::array<char, 256> buffer{};
    std::string result;

    // 2>&1: gộp stderr vào stdout để nếu piTest báo lỗi cũng đọc được
    FILE* pipe = popen((cmd + " 2>&1").c_str(), "r");
    if (!pipe) {
        std::perror("popen failed");
        return "";
    }

    while (fgets(buffer.data(), buffer.size(), pipe) != nullptr) {
        result += buffer.data();
    }

    int rc = pclose(pipe);
    std::cerr << "[DEBUG] piTest exit code: " << rc << std::endl;

    return result;
}

// Hàm đọc analog input với piTest -q
// channelName ví dụ: "AnalogInput_4"
int readAnalogInput(const std::string& channelName) {
    std::string cmd = "piTest -q -r " + channelName;

    std::cerr << "[DEBUG] Running command: " << cmd << std::endl;
    std::string out = execCommand(cmd);

    if (out.empty()) {
        std::cerr << "[ERROR] Empty output from piTest" << std::endl;
        return -1;
    }

    std::cerr << "[DEBUG] Raw piTest output: '" << out << "'" << std::endl;

    // Bỏ hết \n, \r, space...
    out.erase(std::remove_if(out.begin(), out.end(),
                             [](unsigned char c){ return std::isspace(c); }),
              out.end());

    std::cerr << "[DEBUG] Trimmed output: '" << out << "'" << std::endl;

    try {
        int value = std::stoi(out);
        return value;
    } catch (...) {
        std::cerr << "[ERROR] Cannot parse int from: '" << out << "'" << std::endl;
        return -1;
    }
}

int main(int argc, char* argv[]) {
    // Tắt buffer để log ra ngay lập tức
    setvbuf(stdout, nullptr, _IONBF, 0);
    setvbuf(stderr, nullptr, _IONBF, 0);

    std::cout << "RevPi AnalogInput reader start\n";

    // Mặc định đọc AnalogInput_4 nếu không truyền tham số
    std::string channel = "AnalogInput_4";
    if (argc >= 2) {
        channel = argv[1];
    }

    std::cout << "Reading channel: " << channel << std::endl;

    int raw = readAnalogInput(channel);

    if (raw >= 0) {
        std::cout << "Raw value of " << channel << " = " << raw << std::endl;
    } else {
        std::cout << "Failed to read analog input.\n";
    }

    return 0;
}
