// main.cpp
#include <QCoreApplication>
#include <QTcpServer>
#include <QTcpSocket>
#include <QDebug>
#include <QJsonDocument>
#include <QJsonObject>

class SimpleHttpServer : public QTcpServer
{
    Q_OBJECT
public:
    SimpleHttpServer(QObject *parent = nullptr) : QTcpServer(parent) {
        connect(this, &QTcpServer::newConnection, this, &SimpleHttpServer::onNewConnection);
    }

private slots:
    void onNewConnection() {
        QTcpSocket *client = nextPendingConnection();
        connect(client, &QTcpSocket::readyRead, [this, client]() {
            QByteArray data = client->readAll();
            qDebug() << "Recv data:" << data;

            // Rất thô sơ, chỉ demo POST /api/data
            if (data.startsWith("POST /api/data")) {
                int jsonPos = data.indexOf("\r\n\r\n");
                if (jsonPos > 0) {
                    QByteArray jsonData = data.mid(jsonPos + 4);
                    QJsonParseError err;
                    QJsonDocument doc = QJsonDocument::fromJson(jsonData, &err);
                    if (err.error == QJsonParseError::NoError) {
                        qDebug() << "JSON nhận được:" << doc.object();
                        // Response JSON OK
                        QJsonObject resp { {"status", "ok"}, {"received", doc.object()} };
                        QByteArray respBody = QJsonDocument(resp).toJson();
                        QString header = QString(
                            "HTTP/1.1 200 OK\r\nContent-Type: application/json\r\nContent-Length: %1\r\n\r\n"
                        ).arg(respBody.size());
                        client->write(header.toUtf8() + respBody);
                        client->disconnectFromHost();
                    }
                }
            }
        });
    }
};

#include "main.moc"

int main(int argc, char *argv[])
{
    QCoreApplication a(argc, argv);
    SimpleHttpServer server;
    if (!server.listen(QHostAddress::Any, 8080)) {
        qDebug() << "Không thể mở cổng 8080";
        return 1;
    }
    qDebug() << "Server chạy cổng 8080";
    return a.exec();
}
