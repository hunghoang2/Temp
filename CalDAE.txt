#include <cmath>

struct LLA {
    double lat; // độ
    double lon; // độ
    double alt; // mét
};

struct DAE {
    double distance;  // mét
    double azimuth;   // độ
    double elevation; // độ
};

// WGS84 constants
constexpr double a = 6378137.0;           // bán trục lớn (m)
constexpr double f = 1.0 / 298.257223563; // dẹt
constexpr double e2 = f * (2 - f);        // eccentricity^2

// LLA → ECEF
void lla2ecef(const LLA& lla, double& x, double& y, double& z)
{
    double lat = lla.lat * M_PI / 180.0;
    double lon = lla.lon * M_PI / 180.0;
    double N = a / sqrt(1.0 - e2 * sin(lat) * sin(lat));
    x = (N + lla.alt) * cos(lat) * cos(lon);
    y = (N + lla.alt) * cos(lat) * sin(lon);
    z = (N * (1 - e2) + lla.alt) * sin(lat);
}

// ECEF → ENU (với gốc tại lla_ref)
void ecef2enu(const double dx, const double dy, const double dz,
              const LLA& lla_ref,
              double& east, double& north, double& up)
{
    double lat0 = lla_ref.lat * M_PI / 180.0;
    double lon0 = lla_ref.lon * M_PI / 180.0;

    double slat = sin(lat0);
    double clat = cos(lat0);
    double slon = sin(lon0);
    double clon = cos(lon0);

    east  = -slon * dx + clon * dy;
    north = -clon * slat * dx - slat * slon * dy + clat * dz;
    up    =  clat * clon * dx + clat * slon * dy + slat * dz;
}

// Hàm chính: tính DAE từ LLA1 (camera) → LLA2 (mục tiêu)
DAE calcDAE(const LLA& cam, const LLA& target)
{
    double x1, y1, z1, x2, y2, z2;
    lla2ecef(cam, x1, y1, z1);
    lla2ecef(target, x2, y2, z2);

    double dx = x2 - x1;
    double dy = y2 - y1;
    double dz = z2 - z1;

    double east, north, up;
    ecef2enu(dx, dy, dz, cam, east, north, up);

    DAE res;
    res.distance = sqrt(east * east + north * north + up * up);
    res.azimuth = atan2(east, north) * 180.0 / M_PI; // 0° = Bắc, tăng theo chiều kim đồng hồ
    if (res.azimuth < 0) res.azimuth += 360.0;

    res.elevation = atan2(up, sqrt(east * east + north * north)) * 180.0 / M_PI;
    return res;
}
